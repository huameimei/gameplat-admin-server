<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gameplat.admin.mapper.activity.MemberTurntableDao">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.gameplat.admin.model.domain.activity.MemberTurntable">
        <id column="turntable_id" property="turntableId" />
        <result column="begin_time" property="beginTime" />
        <result column="end_time" property="endTime" />
        <result column="type" property="type" />
        <result column="display" property="display" />
        <result column="turn_one" property="turnOne" />
        <result column="turn_ten" property="turnTen" />
        <result column="turn_one_lucky" property="turnOneLucky" />
        <result column="turn_ten_lucky" property="turnTenLucky" />
        <result column="total_lucky" property="totalLucky" />
        <result column="lucky_give" property="luckyGive" />
        <result column="status" property="status" />
        <result column="create_by" property="createBy" />
        <result column="create_time" property="createTime" />
        <result column="update_by" property="updateBy" />
        <result column="update_time" property="updateTime" />
        <result column="remark" property="remark" />
        <result column="turn_title" property="turnTitle" />
        <result column="week_time" property="weekTime" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        turntable_id, begin_time, end_time,type, display, turn_one, turn_ten,turn_one_lucky,turn_ten_lucky,total_lucky,
         lucky_give, status, create_by, create_time, update_by, update_time, remark,turn_title,week_time
    </sql>

    <sql id="where">
		<if test="turnTitle != null and turnTitle != 'null' and turnTitle != ''">
		  and turn_title LIKE CONCAT('%',#{turnTitle},'%')
		</if>
		<if test="display != null and display != 'null' and display != ''">
		  and display = #{display}
		</if>
		<if test="type != null and type != 'null' and type != ''">
		 and type = #{type}
		</if>
		<if test="status != null">
		 and status = #{status}
		</if>
		<if test="turntableId != null">
			and turntable_id = #{turntableId}
		</if>
    </sql>
    <!-- 查询转盘列表 -->
    <select id="findTurntableList" resultMap="BaseResultMap">
    	SELECT <include refid="Base_Column_List" />
    	from member_turntable
    	where 1=1
		<include refid="where"></include>
    </select>

	<!-- 新增转盘 -->
    <insert id="saveTurntable">
    	INSERT INTO member_turntable(
    	<if test="turntableId != null">turntable_id,</if>
    	<if test="beginTime != null">begin_time,</if>
    	<if test="endTime != null">end_time,</if>
    	<if test="type != null">type,</if>
    	<if test="display != null">display,</if>
    	<if test="turnOne != null">turn_one,</if>
    	<if test="turnTen != null">turn_ten,</if>
    	<if test="turnOneLucky != null">turn_one_lucky,</if>
    	<if test="turnTenLucky != null">turn_ten_lucky,</if>
    	<if test="totalLucky != null">total_lucky,</if>
    	<if test="luckyGive != null">lucky_give,</if>
    	<if test="turnTitle != null">turn_title,</if>
    	<if test="weekTime != null">week_time,</if>
    	<if test="status != null">status,</if>
    	<if test="remark != null">remark,</if>
    	<if test="createBy != null">create_by,</if>
    	<if test="createTime != null">create_time</if>
    	)
    	VALUES(
    	<if test="turntableId != null">#{turntableId},</if>
    	<if test="beginTime != null">#{beginTime},</if>
    	<if test="endTime != null">#{endTime},</if>
    	<if test="type != null">#{type},</if>
    	<if test="display != null">#{display},</if>
    	<if test="turnOne != null">#{turnOne},</if>
    	<if test="turnTen != null">#{turnTen},</if>
    	<if test="turnOneLucky != null">#{turnOneLucky},</if>
    	<if test="turnTenLucky != null">#{turnTenLucky},</if>
    	<if test="totalLucky != null">#{totalLucky},</if>
    	<if test="luckyGive != null">#{luckyGive},</if>
    	<if test="turnTitle != null">#{turnTitle},</if>
    	<if test="weekTime != null">#{weekTime},</if>
    	<if test="status != null">#{status},</if>
    	<if test="remark != null">#{remark},</if>
    	<if test="createBy != null">#{createBy},</if>
    	<if test="createTime != null">#{createTime}</if>
    	)
    </insert>

    <!-- 修改转盘 -->
    <update id="updataTurntable">
    	UPDATE member_turntable
    	<set>
    		<if test="beginTime != null">begin_time=#{beginTime},</if>
    		<if test="endTime != null">end_time=#{endTime},</if>
    		<if test="type != null">type=#{type},</if>
    		<if test="display != null">display=#{display},</if>
    		<if test="turnOne != null">turn_one=#{turnOne},</if>
    		<if test="turnTen != null">turn_ten=#{turnTen},</if>
    		<if test="turnOneLucky != null">turn_one_lucky=#{turnOneLucky},</if>
    		<if test="turnTenLucky != null">turn_ten_lucky=#{turnTenLucky},</if>
    		<if test="totalLucky != null">total_lucky=#{totalLucky},</if>
    		<if test="luckyGive != null">lucky_give=#{luckyGive},</if>
    		<if test="turnTitle != null">turn_title=#{turnTitle},</if>
    		<if test="weekTime != null">week_time=#{weekTime},</if>
    		<if test="status != null">status=#{status},</if>
    		<if test="remark != null">remark=#{remark},</if>
    		<if test="updateBy != null">update_by=#{updateBy},</if>
    		update_time = sysdate()
    	</set>
    	 WHERE turntable_id=#{turntableId}
    </update>

	<!-- 查询单个转盘信息 -->
	<select id="findTurntable" resultMap="BaseResultMap">
		SELECT <include refid="Base_Column_List" />
		from member_turntable
		where 1=1
		<include refid="where"></include>
		and NOW() &gt;= begin_time
		and NOW()  &lt;= end_time
		and locate(DAYOFWEEK(NOW()),week_time)>0

	</select>

	<select id="findRepetTypeAndDisplay" resultType="int">
	  SELECT count(*) from member_turntable t WHERE t.type=#{type}  and t.display=#{display}
	</select>

	<select id="findTurntableById" resultMap="BaseResultMap">
	  SELECT <include refid="Base_Column_List" /> from member_turntable where turntable_id=#{turntableId}
	</select>

	 <select id="findTurntableStatus" resultType="int">
	  SELECT t.`status` from member_turntable t where t.turntable_id IN(
	  SELECT DISTINCT a.activity_id from member_prize p
	  LEFT JOIN member_activity_prize a
	  ON p.prize_id=a.activity_prize_id
	  where p.prize_id IN
	  <foreach collection="list" item="id" separator="," open="(" close=")">
	            #{id}
	         </foreach>
	  and a.type=2)  and t.`status` != 0
	 </select>

	 <update id="updateTurntableStatus">
	 	update member_turntable set status=0 WHERE turntable_id=#{turntableId}
	 </update>

	 <delete id="deleteTurntable">
		DELETE from member_turntable where status=2 and turntable_id = #{turntableId}
	</delete>

	<update id="online">
		update member_turntable set status=1 where status=2
		and NOW() &gt;= begin_time
		and NOW() &lt;= end_time
	</update>

	<update id="offline">
	update member_turntable set status=0 where status=1
		and NOW() &gt; end_time
	</update>
</mapper>
